<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/studemo.css" />
<link rel="stylesheet" href="css/modal-window.css" />
<!--<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=8Zg69ozQGa4cIKoy3eIRx9P9Y3XTtu4y"></script>-->
<script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&key=2RTBZ-WLTLO-VENWF-SULZS-VCUXE-WUF5Z"></script> <!-- 腾讯地图 -->
<title>汕头大学地图</title>
</head>
<body>
	<div id="allmap"></div>
	<div id="nodelist">
		<div class="btnlist">
			<button id="reset">归位</button>
			<button id="clear">清空</button>
			<button id="generate">生成</button>
		</div>
		<ul class="rectangle-list"></ul>
		<p id="reminder"></p>
	</div>
</body>
<script src="js/jquery-1.11.0.js"></script>
<script src="js/modal.js"></script>
<!--<script src="js/modal-init.js"></script>-->
<script>
$(function(){
	
	var jsonData = {};
	var $reminder = $('#reminder');		//因为要经常用到，所以放入变量中
	var center = new qq.maps.LatLng(23.4130, 116.635);
	//腾讯地图初始化
	stumap = new qq.maps.Map(document.getElementById("allmap"),{
		center: center,
		zoom: 16,
		minZoom:15,
		panControl:false,
		zoomControl:false,
	});
	
	//添加一个点
	function addMarker(lng, lat, title, id){
		
		var point = new qq.maps.LatLng(lat, lng);
		var marker = new qq.maps.Marker({	//添加标注点
			position: point,
			map: stumap,
			title: String(id)
		});
		
		var label = new qq.maps.Label({		//添加标注信息
			position: point,
			map: stumap,
			offset: new qq.maps.Size(10, -5),
			content: title
		});
		
		label.setStyle({	//标注样式
			color: "#444", 
			backgroundColor: "ghostwhite",
			border: "1px solid #DDDDDD",
			fontSize: "12px",
		});
		
		qq.maps.event.addListener(marker, 'mouseover', function() {		//鼠标放置跳动
			this.setAnimation(qq.maps.MarkerAnimation.BOUNCE);
		});
		
		qq.maps.event.addListener(marker, 'mouseout', function() {		//鼠标移开停止
			this.setAnimation(null);
		});
		
		qq.maps.event.addListener(marker, 'click', function(){	//点击加入到列表
			var $list = $('#nodelist>ul>li>a');
			var flag = 0
			var thisMarker = label.getContent()
			$list.each(function(){
				flag = ($(this).text()===thisMarker)?1:flag;
			});
			if(flag === 1){
				$reminder.text('已存在');
			}else{
				$reminder.text('');
				$('<li><a href="">' + label.getContent() + '</a><span class="invisible">' + this.getTitle() + '</span></li>').appendTo('#nodelist ul').hide().fadeIn(300);
			}
		});
		
		qq.maps.event.addListener(label, 'click', function(){		//点击标注展示照片
			openView(this.getContent());
		});
		
		label.setVisible(true);
	}
	
	//照片展示
	function openView(name){
		var elContent = '<div class="modal-view"><img src="images/' + name +'.png" /></div>';
		var $content = $(elContent);   
		modal.open({
			content: $content,
			width:800, 
			height:600
		});
	}
	
	//添加删除事件+事件代理
	$('ul.rectangle-list').on('click', 'li a', function(e){
		e.preventDefault();
		$reminder.text('');
		$(this).animate({
			opacity: 0.0,
		}, 300, function(){ //加了easing参数就运行不了
			$(this).remove();
		});
	});
	
	//给按钮添加事件
	$('div.btnlist').on('click', 'button', function(e){
		e.preventDefault();
		var id = $(this).attr("id");
		if(id === 'reset'){		//点击归位
			stumap.setCenter(center);
			stumap.setZoom(16);
		}else if(id === 'clear'){		//点击清空
			$('ul.rectangle-list').animate({		//动画
				opacity:0.0,
				paddingLeft:'+=200'
			}, 500, function(){			
				$('ul.rectangle-list').html('').animate({
					opacity:1,
					paddingLeft:'-=200'
				},1);
			});
			$reminder.text('');		//清空reminder
		}else if(id === 'generate'){		//点击生成
			var selected = new Array();
			$('ul.rectangle-list>li>a').each(function(index){
				selected.push(parseInt($(this).next().text()));		//传入的是整数
			});
			$('ul.rectangle-list').html('');
			$reminder.text('');
			//selected是一个数组对象 其length属性为数组的长度
		}
	});
	
	//载入JSON
	$.ajax({
		beforeSend: function(xhr){		//该方法告知应该返回JSON数据
			if(xhr.overrideMimeType){	
				xhr.overrideMimeType("application/json");
			}
		}
	});
	
	$.getJSON('data/data.json')
	.done(function(data){
		jsonData = data;
		for(var i = 0; i < jsonData.length; i ++){
			addMarker(jsonData[i].lng, jsonData[i].lat, jsonData[i].name, i);
		}
	}).fail(function(){
		alert("找不到数据！");
	});
	
	
	//test
//	openView('STU平面图');
	
//	qq.maps.event.addListener(stumap, 'click', function(event) {
//        alert('"lng": ' + event.latLng.getLng() +
//        ',' + '"lat": ' + event.latLng.getLat());
//    });
});
</script>
</html>
